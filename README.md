gRPC in 3 minutes (C#)
========================

Modified example from the official [gRPC repo](https://github.com/grpc/grpc/tree/master/examples/csharp/Helloworld), adapted to .NET 5, Docker and Kubernetes.

You can compile it and run it with [Visual Studio 2022][VS2022] and you will find a [Kubernetes deployment file][deployment] that will run the service and one client inside a k8s cluster.

MODIFICATIONS TO THE ORIGINAL EXAMPLE
---

This example has been modified to demonstrate a deployment into a K8s cluster:

 * The [client][client] runs in a loop and takes the server address as an environment value called `GRPCSERVER`.
 * The [server][server] now is bound to the 0.0.0.0 address and sends the server name into the response to easily check if there is load balancing present.
 * Two Dockerfile have been created to allow containerizing the solution, they have been autogenerated with Visual Studio, and modified to workaround a runtime issue that needs the c++ dev tools
 * A [K8s deployment file][deployment] has been created to demonstrate how to run it in Kubernetes, it has the needed labels to allow [Linkerd][linkerd] to load-balance the calls.

PREREQUISITES
---
* [Visual Studio 2022][VS2022] and [Docker Desktop][DockerDesktop] to build and run the Greeter.sln.
* An [AKS][AKS] cluster
* A [Container Registry][containerregistry] for storing the Docker images



HOW TO RUN IN K8s
---

In Visual Studio right click on the GreeterServer project and click into `Publish` to publish it to your [Container Registry][containerregistry]. Do the same for the GreeterClient.

Once you have the containers uploaded to the CR, modify the deployment.yaml file with the image names of your registry and run `kubectl apply -f deployment.yaml`

Once all the deployment is up and running you can check the logs of the client:

```bash
kubectl logs pod/greeter-client greeter-client -n greeter -f
```

LOAD BALANCING
---

When you deploy this service to an [AKS][AKS] cluster and test it you will notice that even thought you are deploying 3 replicas of the service, the client is always connecting to the same one. This is a side effect of the gRPC connection using HTTP/2, that tries to have a single long-lived TCP connection as explained in the [Kubernetes documentation][gRPClb].

To enable load balancing you will need to add a Service Mesh like [Linkerd][linkerd]. The [deployment][deployment] file already contains the annotations to add the Linkerd sidecar proxies to your containers, so you only need to follow the [install guide][linkerdinstall] provided by Linkerd, and then redeploy the service:

```bash
kubectl delete -f deployment.yaml ; kubectl apply -f deployment.yaml
```


---

Original content below:

---

BACKGROUND
-------------
This is a version of the helloworld example using the dotnet SDK
tools to compile [helloworld.proto][] in a common library, build the server
and the client, and run them.

PREREQUISITES
-------------

- The [.NET Core SDK 2.1+](https://www.microsoft.com/net/core)

You can also build the solution `Greeter.sln` using Visual Studio 2017,
but it's not a requirement.

BUILD AND RUN
-------------

- Build and run the server

  ```
  > dotnet run -p GreeterServer
  ```

- Build and run the client

  ```
  > dotnet run -p GreeterClient
  ```

Tutorial
--------

You can find a more detailed tutorial about Grpc in [gRPC Basics: C#][]

[AKS]: https://docs.microsoft.com/azure/aks/
[client]: ./GreeterClient/Program.cs
[containerregistry]: https://docs.microsoft.com/azure/container-registry/
[deployment]: ./deployment.yaml
[DockerDesktop]: https://www.docker.com/products/docker-desktop
[helloworld.proto]:Greeter/helloworld.proto
[gRPC Basics: C#]:https://grpc.io/docs/languages/csharp/basics
[gRPClb]: https://kubernetes.io/blog/2018/11/07/grpc-load-balancing-on-kubernetes-without-tears/
[linkerd]: https://linkerd.io/2.11/getting-started/
[linkerdinstall]: https://kubernetes.io/blog/2018/11/07/grpc-load-balancing-on-kubernetes-without-tears/#grpc-load-balancing-in-60-seconds
[server]: ./GreeterServer/Program.cs
[VS2022]: https://visualstudio.microsoft.com/vs/
